name: Build Lovable preview â†’ build branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    env:
      PREVIEW_URL: "https://id-preview--184f49e9-a6ef-4ad2-8764-c7f74a6fd053.lovable.app/"
      BUILD_BRANCH: "build"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Fetch preview HTML and assets and produce build files
        run: |
          python3 - <<'PY'
          import os, sys
          from urllib.parse import urljoin, urlparse
          import requests
          from bs4 import BeautifulSoup

          PREVIEW = os.environ.get('PREVIEW_URL')
          if not PREVIEW:
              print("PREVIEW_URL not set"); sys.exit(1)

          session = requests.Session()
          print("Fetching:", PREVIEW)
          r = session.get(PREVIEW)
          r.raise_for_status()
          soup = BeautifulSoup(r.text, 'html.parser')

          assets_dir = 'assets'
          os.makedirs(assets_dir, exist_ok=True)

          def save_url(url):
              # skip data: URIs
              if url.startswith('data:'):
                  return None
              full = urljoin(PREVIEW, url)
              parsed = urlparse(full)
              filename = os.path.basename(parsed.path)
              if not filename:
                  return None
              out_path = os.path.join(assets_dir, filename)
              print("Downloading", full, "->", out_path)
              resp = session.get(full)
              resp.raise_for_status()
              with open(out_path, 'wb') as f:
                  f.write(resp.content)
              return filename

          # Update link href, script src, img src paths and download assets
          for tag in soup.find_all(['link','script','img']):
              if tag.name == 'link' and tag.get('href'):
                  href = tag['href']
                  fn = save_url(href)
                  if fn:
                      tag['href'] = './assets/' + fn
              if tag.name == 'script' and tag.get('src'):
                  src = tag['src']
                  fn = save_url(src)
                  if fn:
                      tag['src'] = './assets/' + fn
              if tag.name == 'img' and tag.get('src'):
                  src = tag['src']
                  fn = save_url(src)
                  if fn:
                      tag['src'] = './assets/' + fn

          # Save index.html
          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(str(soup))

          # Ensure index.php and style.css exist (theme headers)
          if not os.path.exists('index.php'):
              with open('index.php','w') as f:
                  f.write("<?php\n$path = get_stylesheet_directory() . '/index.html';\nif (file_exists($path)) { echo file_get_contents($path); } else { echo 'index.html not found'; }\n")
          if not os.path.exists('style.css'):
              with open('style.css','w') as f:
                  f.write("/*\\nTheme Name: MFB Unconference\\nTheme URI: https://bitcoinindonesia.xyz/unconference/\\nAuthor: Bitcoin Indonesia\\nVersion: 1.0\\n*/\\n")
          print("Built index.html and saved assets.")
          PY

      - name: Publish build into orphan 'build' branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_BRANCH: ${{ env.BUILD_BRANCH }}
        run: |
          echo "Preparing clean build branch: $BUILD_BRANCH"
          REPO="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          mkdir -p ../buildrepo
          # copy only the generated build files and theme helpers
          cp index.html index.php style.css -r assets ../buildrepo/ || true
          cd ../buildrepo
          git init
          git remote add origin "$REPO"
          git checkout -b "$BUILD_BRANCH"
          git add .
          git commit -m "chore: build from Lovable preview" || echo "nothing to commit"
          git push origin "$BUILD_BRANCH" --force
