name: Build Lovable preview â†’ build branch

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    env:
      PREVIEW_URL: "https://id-preview--184f49e9-a6ef-4ad2-8764-c7f74a6fd053.lovable.app/"
      BUILD_BRANCH: "build"
      BASE_PATH: "/unconference/"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Fetch Lovable preview and build static site
        run: |
          python3 - <<'PY'
          import os, sys
          from urllib.parse import urljoin, urlparse
          import requests
          from bs4 import BeautifulSoup

          PREVIEW = os.environ.get("PREVIEW_URL")
          BASE_PATH = os.environ.get("BASE_PATH", "/")
          if not PREVIEW:
              print("PREVIEW_URL not set")
              sys.exit(1)

          session = requests.Session()
          print("Fetching:", PREVIEW)
          r = session.get(PREVIEW)
          r.raise_for_status()

          soup = BeautifulSoup(r.text, "html.parser")

          # Inject <base href="/unconference/">
          base_tag = soup.new_tag("base", href=BASE_PATH)
          soup.head.insert(0, base_tag)

          assets_dir = "assets"
          os.makedirs(assets_dir, exist_ok=True)

          def save_url(url):
              if not url or url.startswith("data:"):
                  return None
              full = urljoin(PREVIEW, url)
              parsed = urlparse(full)
              filename = os.path.basename(parsed.path)
              if not filename:
                  return None
              out_path = os.path.join(assets_dir, filename)
              print("Downloading", full)
              resp = session.get(full)
              resp.raise_for_status()
              with open(out_path, "wb") as f:
                  f.write(resp.content)
              return filename

          # Remove dev-only scripts like /src/main.tsx
          for script in soup.find_all("script"):
              src = script.get("src", "")
              if src.startswith("/src/"):
                  script.decompose()

          # Download and rewrite assets
          for tag in soup.find_all(["link", "script", "img"]):
              attr = "href" if tag.name == "link" else "src"
              if tag.get(attr):
                  fn = save_url(tag.get(attr))
                  if fn:
                      tag[attr] = "./assets/" + fn

          # Write index.html
          with open("index.html", "w", encoding="utf-8") as f:
              f.write(str(soup))

          # index.php to serve static HTML as WP theme
          with open("index.php", "w") as f:
              f.write(
                  "<?php\n"
                  "$path = get_stylesheet_directory() . '/index.html';\n"
                  "if (file_exists($path)) {\n"
                  "  echo file_get_contents($path);\n"
                  "} else {\n"
                  "  echo 'index.html not found';\n"
                  "}\n"
              )

          # style.css theme header (required by WordPress)
          with open("style.css", "w") as f:
              f.write(
                  "/*\n"
                  "Theme Name: MFB Unconference\n"
                  "Theme URI: https://bitcoinindonesia.xyz/unconference/\n"
                  "Author: Bitcoin Indonesia\n"
                  "Version: 1.0\n"
                  "*/\n"
              )

          print("Static build complete.")
          PY

      - name: Publish build to orphan build branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_BRANCH: ${{ env.BUILD_BRANCH }}
        run: |
          echo "Publishing to branch: $BUILD_BRANCH"

          REPO="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          mkdir -p ../buildrepo
          cp index.html index.php style.css -r assets ../buildrepo/
          cd ../buildrepo

          git init
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git remote add origin "$REPO"
          git checkout -b "$BUILD_BRANCH"
          git add .
          git commit -m "chore: build from Lovable preview" || echo "No changes"
          git push origin "$BUILD_BRANCH" --force
