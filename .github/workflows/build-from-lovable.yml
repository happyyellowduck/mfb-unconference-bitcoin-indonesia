name: Build Lovable preview â†’ build branch

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    env:
      PREVIEW_URL: "https://id-preview--184f49e9-a6ef-4ad2-8764-c7f74a6fd053.lovable.app/"
      BUILD_BRANCH: "build"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Fetch preview HTML and assets and produce build files
        run: |
          python3 - <<'PY'
          import os, sys
          from urllib.parse import urljoin, urlparse
          import requests
          from bs4 import BeautifulSoup

          PREVIEW = os.environ.get('PREVIEW_URL')
          if not PREVIEW:
              print("PREVIEW_URL not set")
              sys.exit(1)

          session = requests.Session()
          print("Fetching:", PREVIEW)
          r = session.get(PREVIEW)
          r.raise_for_status()
          soup = BeautifulSoup(r.text, 'html.parser')

          assets_dir = 'assets'
          os.makedirs(assets_dir, exist_ok=True)

          def save_url(url):
              if url.startswith('data:'):
                  return None
              full = urljoin(PREVIEW, url)
              parsed = urlparse(full)
              filename = os.path.basename(parsed.path)
              if not filename:
                  return None
              out_path = os.path.join(assets_dir, filename)
              print("Downloading", full, "->", out_path)
              resp = session.get(full)
              resp.raise_for_status()
              with open(out_path, 'wb') as f:
                  f.write(resp.content)
              return filename

          for tag in soup.find_all(['link','script','img']):
              if tag.name == 'link' and tag.get('href'):
                  fn = save_url(tag['href'])
                  if fn:
                      tag['href'] = './assets/' + fn
              if tag.name == 'script' and tag.get('src'):
                  fn = save_url(tag['src'])
                  if fn:
                      tag['src'] = './assets/' + fn
              if tag.name == 'img' and tag.get('src'):
                  fn = save_url(tag['src'])
                  if fn:
                      tag['src'] = './assets/' + fn

          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(str(soup))

          with open('index.php','w') as f:
              f.write(
                  "<?php\n"
                  "$path = get_stylesheet_directory() . '/index.html';\n"
                  "if (file_exists($path)) {\n"
                  "  echo file_get_contents($path);\n"
                  "} else {\n"
                  "  echo 'index.html not found';\n"
                  "}\n"
              )

          with open('style.css','w') as f:
              f.write(
                  "/*\n"
                  "Theme Name: MFB Unconference\n"
                  "Theme URI: https://bitcoinindonesia.xyz/unconference/\n"
                  "Author: Bitcoin Indonesia\n"
                  "Version: 1.0\n"
                  "*/\n"
              )

          print("Build complete.")
          PY

      - name: Publish build into orphan 'build' branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_BRANCH: ${{ env.BUILD_BRANCH }}
        run: |
          echo "Preparing clean build branch: $BUILD_BRANCH"

          REPO="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          mkdir -p ../buildrepo
          cp index.html index.php style.css -r assets ../buildrepo/ || true
          cd ../buildrepo

          git init
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git remote add origin "$REPO"
          git checkout -b "$BUILD_BRANCH"
          git add .
          git commit -m "chore: build from Lovable preview" || echo "nothing to commit"
          git push origin "$BUILD_BRANCH" --force
